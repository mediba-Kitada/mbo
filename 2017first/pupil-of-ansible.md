# Ansible入門講座
受講すると、WordPressサーバ(DB含む)をプロビジョニング出来るようになります。  
__2017/7現在 Mac(OSX)で開発しているエンジニア限定です!__

## 下ごしらえ

- Ansibleのバージョンアップ
	- 少なくとも2系を利用しましょう。

```
$ brew upgrade ansible

# バージョン確認
$ ansible --version
  config file =
  configured module search path = Default w/o overrides
  python version = 2.7.13 (default, Dec 17 2016, 23:03:43) [GCC 4.2.1 Compatible Apple LLVM 8.0.0 (clang-800.0.42.1)]
```

- SSH接続設定
	- 渋谷オフィスにて、`MediFi5` もしくは `MediFi2` 、LANケーブルのいずれかに接続してください。
	- 秘密鍵をお渡ししますので、適切なパーミッションで所定のディレクトリに配置してください。

```
$ cp /path/to/worpress ~/.ssh
$ chmod 400 ~/.ssh/worpress
```

## なぜAnsibleか

社内のプロビジョニングツールとして標準である理由

### 構文がシンプル
- >実行可能なドキュメント

### リモートホスト(プロビジョニング対象のサーバ)へのインストールが不要
- SSH
- Python 2.5以降
- Python 2.4(simplejsonライブラリ)

### プッシュベース
- プルベースの場合、リモートホストにエージェントが必要

### スケールダウン
- >シンプルなことはシンプルなまま、そして複雑なことも実行可能であるべき

### 組み込みモジュール
- >モジュールを使えば、パッケージのインストール、サービスの再起動、設定ファイルのコピーといったタスクを実行出来ます。
- 宣言的に実装し、冪等性の確保が見込める

### 抽象化層の薄さ
- >モジュールのスコープは小さく、オペレーティングシステムごとにできるので、充分に定義された、共有可能なモジュールを単純明快に実装できるのです。
- yumは`yum`モジュール、aptは`apt`モジュール

## Ansibleとは何か

### play

- ホスト群と、そのホスト群で実行するタスクのリストの関連づけ。

### playbook

- Ansibleのスクリプト。playのリストと、それらのplayの実行対象となるホストの集合を指定する。

### タスク

- Ansibleのplay中の作業の単位。1つのタスクは、モジュールとその引数、そしてオプションで名前や追加パラメータを指定する。

### ハンドラ

- タスクに似ているが、状態が変化した際にハンドラに対して通知するように設定されたタスクから通知されたときにのみ動作する。

### モジュール

- 特定のタスクを1つ実行するAnsibleのスクリプト。

### インベントリ

- ホストとグループのリスト。

### ファクト

- ホストに関する情報を含む変数。

### ロール

- タスク、ハンドラ、ファイル、テンプレート、変数をまとめるためのAnsibleの仕組み。

## Ansibleを通じて覚えておきたい概念

### プロビジョニングとデプロイ

同様のプロセスだが、対象がミドルウェアかソフトウェアかで分別されることが多い。

#### プロビジョニング

- サーバ群の状態を何らかの形で記述し、ツールを使ってサーバが実際にその状態にするプロセス。

#### デプロイ

- ソフトウェアを動作するシステムに持ち込むプロセス。

### 冪等

- 複数回実行しても、一度だけ実行しても結果が同じようになるようなアクションのことを、冪等なアクションという。

### 宣言的

- プログラミング言語の種類で、プログラマは出力を求めるための手段ではなく、希望する出力そのものを記述する。
- Ansibleのplaybookは宣言的である。
- SQLは、宣言的言語のひとつの例である。

## 実習

コードベースにまとめました。  

- [mediba-Kitada/ansible-tutorial](https://github.com/mediba-Kitada/ansible-tutorial)

Ansible Playbookに不具合が注入されており、修正し、プロビジョニングを正常に完了することで、WordPressの設定画面が表示されるようになります。
不具合修正を通して、Ansible Playbookのベストプラクティスを学び、プロビジョニングの流れを体得することを目的とした実習です。


詳細は、READMEをご確認ください。
受講者別にセットアップし、ブランチを用意しておりますので、ご所望の方は北田までご連絡下さい。

## 参考

- [初めてのAnsible](https://www.oreilly.co.jp/books/9784873117652/)
- [Ansible チュートリアル](http://yteraoka.github.io/ansible-tutorial/)
