# 主題202 システムの起動

## システムの起動をカスタマイズする

### systemd
- 処理単位であるユニット
- ユニットの集合体であるターゲット
- OSに関わる操作も実施

#### target
- `poweroff.target` ランレベル0に相当
- `rescue.target` ランレベル1(シングルユーザーモード)に相当
- `multi-user.target` ランレベル2-4に相当
- `graphical.target` ランレベル5に相当
- `reboot.target` ランレベル6に相当
- `default.target` シンボリックリンクファイルを示すファイルであり、`/etc/systemd/system`に配置
- SysVinitにおけるランレベルに相当する概念

#### service
- サービスを起動、停止する

#### mount
- ファイルシステムをマウントする

#### device
- udevによって認識されてデバイス


#### /usr/lib/systemd/system
- 永続的なユニット、ターゲットの定義ファイルを配置

#### /etc/systemd/system
- カスタム用のディレクトリ
- 優先度が高い

#### /run/systemd/system
- 再起動すると削除されるディレクトリ
- `/usr/lib`より優先度が高い

#### systemctl
- `get-default` デフォルトターゲットの名前を表示
- `set-default` デフォルトターゲットを設定
- `poweroff` 電源OFF
- `emergency` 緊急モードに移行
- `rescue` レスキューモードに移行
- `default` 標準のモードに移行
- `reboot` 再起動
- `isolate multi-user.target` multi-userターゲット以外のユニット、ターゲットを停止し、multi-userターゲットを実行
	- SysVinitにおけるランレベルの変更
- `list-units` ユニット一覧を表示する

#### systemd-delta
- 起動スクリプトへの影響を調査、表示する

### SysVinit
#### initプロセス
- カーネルにより起動される特殊なプロセス
- PIDが1(固定)
- `/etc/inittab`を読み込み、ランレベルを確認
    - GRUBの設定ファイルにカーネル起動時のコマンドパラメータとしても記載出来る
- ランレベル毎の処理を実施

#### /etc/rc[0-6].d
- `S85httpd`
	- S 起動
        - K 停止
        - K -> Sの順序で実行
	- 85 実行順序(昇順)
	- httpd サービス名

#### /etc/init.d
- 起動スクリプトの実体が配置されている

#### telinit
- initプロセスに指示を出し、ランレベルを変更することができるコマンド
- `init`コマンドと同様の使い方ができる
- 管理権限を持ったスーパーユーザでしか利用出来ない
- システムを再起動させることができる
- `Q` /etc/inittabを再読込

#### /etc/inittab
- `l0:0:wait:/etc/rd.d/rc 0`
	- l0 ID
	- 0 ランレベル
	- wait アクション指示子 プロセスが終了するまで次の処理を行わない
        - bootwait ブート時に起動し、プロセスの終了を確認してから次の処理に移行
        - `boot` ブート時に実行する
        - `sysinit` bootより優先して実行する
        - `respawn` プロセスが終了しても自動的に再起動
        - `default` デフォルトのランレベルを設定
	- /etc/rd.d/rc 0 処理
- `id:3:initdefault:` デフォルトランレベルを3に設定

#### insserv
- SUSE系ディストリビューションで各種サービスを自動起動設定
- `-r` 自動起動設定を削除

#### update-rc.d
- `update-rc.d [option] SERVICE 操作`
    - `update-rc.d sshd start 25 1 2 4` S25SSHDのシンボリックリンクを`/etc/rd[1,2,4].d`に作成
- 各種サービスの自動起動設定
- 各種サービスの優先順位設定
- v6.0より以前のDebian系ディストリビューションで標準だった
- `default` ランレベルに応じてS,Kで始まるリンクを作成
- `remove` シンボリックリンクを削除 

#### chkconfig
- RedHad系ディストリビューションで各種サービスを自動起動設定
- `--level` ランレベルを省略した場合、2,3,4,5が対象となる

#### runlevel
- 現在のランレベルと以前のランレベルを表示

## システムのリカバリ

### GRUB Legacy

#### /boot/grub/device.map
- GRUBが認識しているドライブ名とカーネルが認識しているデバイス名の対応を記録

#### /boot/grub/menu.lst
- `root` カーネルイメージが格納されているパーティションを指定
- `kernel` カーネルイメージファイルの指定
	- `root`で指定したファイルシステム上のパス


### /proc/cmdline
- コマンドライン・オプションの確認が出来る

#### カーネルの起動オプション
- `kernel /boot/vmlinuz-2.6.35 {single,s,1}` シングルユーザモードで起動
- `kernel /boot/vmlinuz-2.6.35 root=/dev/sda2` ルートファイルシステムを`/dev/sda2`に指定して起動
- `kernel /boot/vmlinuz-2.6.35 nosmp | maxcpus=0` マルチプロセッサマシンをシングルプロセッサマシンとして起動

### GRUB2

#### /boot/default/grub
- `menuentry` 各項目の名前としてメニューに表示される文字列を設定
- `set root='(hd0,3)'` カーネルイメージが格納されているパーティションを指定
- `linux /boot/vmlinuz-3.2.0-29-generic-pae root=/dev/sda1 ro 1` カーネルイメージファイルの指定(パスを指定)
	- GRUB Legacyのkernelに相当
	- 末尾の数字がランレベル

### UEFI

#### GPT
- パーティションテーブルに関する標準規格
- ESPを包含する

#### EFI System Partition
- UEFIにおいて、物理的なマシン起動後に、その後の起動シーケンスの最初にアクセスされる領域
- FAT16または、FAT32でフォーマットされる

#### UEFIブートマネージャー
- 起動情報(OSをどこからどのようにロードするか)を管理するプログラム
- BIOSにおけるブートローダのような役割を果たす
- `/EFI/BOOT/bootx64.efi`

#### efibootmgr
- UEFIブートマネージャーの起動エントリをOS上から操作するコマンド

#### UEFI shell
- OSを起動せずにハードウェア周りを設定することででき、デバイスドライバやTCP/IPスタックも利用可能

#### shim.efi
- セキュアブート時に最初に読み込まれるUEFIアプリケーション

#### grubx64.efi
- grubを起動するUEFIアプリケーション

#### systemd-boot
- systemd独自のUEFIブートマネージャー
- ESPにsystemd-bootのバイナリが必要

#### U-boot
- オープンソースの組み込み用のブートローダ

#### efiboot.img
- UEFIでISOLINUXを使ってブートする際に使われるイメージ
- FAT16で作成されている


### isohdfpx.bin
- SYSLINUXのMBRコード

### 起動の中止
- ルートファイルシステムをマウント出来ない
- `init`プロセスが見つからない

### rdev
- ルートデバイスを設定するコマンド
- `rdev /dev/fd0 /dev/hda1` カーネルイメージ(`/dev/fd0`)にルートファイルシステムの位置(`/dev/hda1`)を書き込む

### initramfs
- システム起動に借りの環境としてメモリ上にファイルシステムを展開し、カーネルを動作させてから本来のファイルシステムをルートにマウントする
- カーネルからは通常のファイルシステムと同様にアクセス出来、格納されているプログラムを実行することも出来る(initプロセスを起動させる)

### fsck
- 起動時に`fsck`によるファイルシステムの検査、修復が行われる
- 検査と書き込みのバッティングを避けるため、起動時は1度読み込み専用でマウントし、検査完了後に読み書きできるように再マウントする

### /etc/fstab
- `fsck`による順序を指定出来る

## その他のブートローダ

### PXELINUX
- SYSLINUXパッケージに含まれるブートローダ
- PXE(Preboot Execution Environment)を使用してネットワークサーバからLinuxを起動するブートローダ
	- PXEは、ネットワーク経由でOSを起動するための規格でDHCPサーバやTFTPサーバを仕様
	- HDDにインストールはしないので、ディスクレスマシンでも起動する

#### pxelinux.0
- ブートローダ本体のファイル名

#### pxelinux.cfgディレクトリ
- `pxelinux.0`と同一ディレクトリに格納されている設定ファイルを格納するディレクトリ

### Isohybrid
- USBスティックなどでISOLINUXイメージのMBRコードを使ったブートを可能にし、ブロックデバイスの動作を提供するシステム

### EXTLINUX
- SYSLINUXパッケージに含まれるブートローダ
- ext2/ext3/ext4/btrfsからLinuxを起動させる
- `extlinx`コマンドでインストール
	- `extlinux --install /boot`

### SYSLINUX
- SYSLINUXパッケージに含まれるブートローダ
- FATファイルシステムからLinuxを起動する軽量のブートローダ
	- FATファイルシステムは、MS-DOSやWindowsなどのOSで使用されるファイルシステム
- 機能が少なく軽量
- FDDやUSBメモリからの起動に主に使用される
- `syslinux -i|--install /dev/sdb1` USBメモリ`/dev/sdb1`にSYSLINUXをインストール

### ISOLINUX
- CD-ROMで使用されるISO 9660ファイルシステムから起動するブートローダ
-`isolinux.bin` ISOLINUX本体
- `isolinux.cfg` 設定ファイル 本体と同一ディレクトリに格納
