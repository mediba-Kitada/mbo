# 主題203 ファイルシステムとデバイス

## Linuxファイルシステムの操作と保守

### /etc/fstab
- `デバイス マウントポイント ファイルシステム種類 オプション dumpフラグ fsckフラグ`
- `users` どのアカウントでもマウント/アンマウント出来る
- `uid=staff` staffユーザが読み書きできるようにする
- `nouser` 一般ユーザによるマウントを禁止
- `async` 非同期で入出力を行う
- `defaults` `async, auto, exec, nouser, rw`と同様

### /etc/filesystems
- 現在のシステムで利用可能なファイルシステムの一覧が記載されている

### 汎用的(ルートパーティションにも使用される)なファイルシステム
- ext2
- ext3
	- ジャーナリング機能を模圧
	- ブロックサイズは、ファイルシステム作成時に決められる
	- データブロックには、ファイルの内容が格納されている
	- iノードブロックには，ファイルのメタ情報が格納されている
	- スーパーブロックには、ファイルシステム全体に関わる重要な情報が格納されており、冗長化されている
- ext4
	- RHEL6, Ubuntuなど
	- ext3の後継
	- 1EiBのファイルシステムをサポートする
- XFS
	- RHEL7, CentOS, Oracle Linux
- btrfs

### btrfs
- ZFSを参考として開発
- スナップショットなどの機能を持つ
	- スナップショットをとる単位としてサブボリュームを作成
- 比較的新しい

### ZFS
- UFSの後継
- Oracleが管理しているファイルシステム
- ソフトウェアRAIDやスナップショット等を比較的簡単に扱うことが出来る

#### btrfsコマンド
- `subvolume create` サブボリュームの作成
- `subvolume snapshot` スナップショットを作成
- `filesystem show` ファイルシステムの情報を表示

#### btrfs-convert
- `ext3`ファイルシステムからbtrfsファイルシステムへの変換

### mkswap
- スワップ領域を作るコマンド

### /proc/swaps
- `swapon -s`と同様にスワップ領域の利用状況を知ることが出来る

### /dev/disk/by-uuid
- 各デバイスのUUIDを調べることが出来る
- `udev`が自動生成する

### ファイルシステム
- 記録デバイス上に構築される、ファイルやディレクトリを単位としてデータを管理するための仕組み
- ルートファイルシステム内に複数のファイルシステムをマウント出来る
	- 複数のファイルシステムからなるディレクトリ構造を作成する
	- `/tmp` `/proc` 特殊な用途のディレクトリは、ルートファイルシステムとは異なる特殊なファイルシステムがマウントされている

### システムコール
- OSの機能を呼び出すための仕組み

### mount
- `mount /dev/sda1 /boot` /dev/sda1にあるファイルシステムを/bootにマウント
- `/etc/fstab`に設定が存在する場合は、デバイスかマウント左記のどちらかを指定でも可能
- `-o ro /boot` `/etc/fstab`で設定されている`/boot`を読み込み専用でマウント
- オプション引数をつけずに実行すると、現在マウントされているファイルシステムの一覧を表示

### umount
- `-a` `/etc/mtab`に記載れているファイルシステムを全てアンマウントする
- `-t` 指定した種類のファイルシステムのみ対象

### iso9660
- CD-ROMで利用されるファイルシステム

### tmpfs
- メモリ上に作られる揮発性の特殊ファイルシステム

### Out Of Memory Killer
- OOM Killer
- メモリ不足時の自動プロセス停止機能

### fuser
- 指定したファイルシステムに対してアクセスを行っているプロセス一覧を得たり、該当プロセスをkillしたり出来る

### /lost+found
- どこからも参照されていないファイルの保管場所
- ファイルシステムの異常等により、ファイルやディレクトリを正常に参照できなくなった場合に有用

### fdisk
- パーティション作成
- ハードディスク利用までの流れ `fdisk -> mkfs -> mount`

### /proc/mounts
- `/etc/mtab`と同様に現在マウントされているファイルシステムとそのマウントオプションが記載されている

## Self-Monitoring, Analysis and Reporting Technology System
- SMART
- ハードディスクの問題を発見するための自己診断機能
- 読み取りエラーの発生率やディスクのずれた距離なので多くの項目を監視出来る
- `smartd` 監視用デーモン

### iノード
- ファイルシステムにおいて、記録デバイス上の物理的なデータ位置とファイルを対応付ける役割を持っている情報
- ブロック内に複数存在する
	- 1つのサイズは、128バイト

### 自動マウント

#### automount
- 自動マウントを実施するデーモン

#### /etc/auto.master
- 自動マウントの設定ファイル
- `/- /etc/auto.direct` 直接マップ
- `/auto /etc/auto.cdrom --timeout 60` 間接マップ
	- `/auto` はマウントの起点

#### /etc/auto.direct
- マップファイル
- `/mnt/NFS NFS1:/share` 直接マップ
	- `/mnt/NFS`がマウントポイントとなる

#### /etc/auto.cdrom
- マップファイル
- `cdrom -fstype=iso9660 :/dev/cdrom` 直接マップ
	- `/auto/cdrom`がマウントポイントとなる

## ファイルシステムの作成とオプションの構成

### mkfs
- 対象ファイルシステム
	- ext2
	- ext3
	- ext4
	- xfs
- `-m` root用の予備ブロックを作成
- `-j` ext3として作成
- `-L` ボリュームラベルを指定
- `-b` ブロックサイズをbyte単位で指定
	- `mke2fs -b 1024 /dev/sda3` ext2ファイルシステムを`/dev/sda3`上に作成
- `-n` 確認のみ(実行しない)
	- 事前にiノード数やブロック総数を把握出来る
- `-t` ファイルシステムの種類を指定
### mke2fs
- 対象ファイルシステム
	- ext2
	- ext3
	- ext4

### mkisofs
- `iso9660`ファイルシステムを作成
- `-o` イメージファイル出力先を指定
- `-J` Windows系拡張であるJolietフォーマットで作成
- `-R` UNIX系拡張であるRockRidgeフォーマットで作成
- `-udf` DVDで用いられるUDFフォーマットで作成
	- DVDやBlu-rayのファイルシステムとして採用

### Linux Unified Key Setup
- LUKS
- Linuxにおいて標準的に使用される暗号化ファイルシステムの仕様
- 暗号化は、`cryptsetup`コマンドを利用
	- デバイスマッパーの機能を使った暗号化を実施
- KeySlot 暗号化管理のための鍵をパーティションごとに8つ持っている

### dm-crypt
- デバイスマッパー(device-mapper 物理デバイスと論理デバイスのマッピングを実施する)の暗号化機能を利用
- `cryptsetup` dm-cryptが利用するコマンド

### cryptsetup
- `luksFormat` 暗号化デバイスのフォーマットを行う
- `luksDump` デバイスの暗号化の状態を表示

### fsck
- ファイルシステムのチェックを行う
- `e2fsck`のフロントエンド
- `-t` ファイルシステムを指定して、チェックを行う
- `-b` 指定のスーパーブロックを使い復元を行う
- `-c` 不良ブロックのチェックを行う
- `-p` 自動的に不良ブロックを修復

### e2fsck
- ext2/ext3/ext4のチェックを行う

### tune2fs
- ext2/ext3/ext4の設定を行う
- `-L` ラベルの設定を行う
- `-c` 自動fsckが行われるまでのマウント回数を設定
- `-i` 自動fsckが行われるまでの時間を設定

### e2label
- ext2/ext3/ext4のラベルを設定する専用コマンド

### dumpe2fs
- ext2/ext3/ext4の詳細をダンプする専用コマンド

### xfs_admin
- XFSファイルシステムの設定を行う

### xfs_info
- XFSファイルシステムの情報を表示する

### xfs_check
- `xfs`ファイルシステムのチェックを行う

### xfsrestore
- XFSファイルシステムの復元を行う

### xfsdump
- XFSファイルシステムのバックアップを行う

### debugfs
- ext2/ext3/ext4の対話デバッグを行うコマンド
- 専用シェルを起動し、対話的に調査や編集を行う
