# 主題200 キャパシティプランニング

## リソース使用率とトラブルシューティング

- ![commands](http://ping-t.com/mondai3/img/jpg/k29132.jpg)

### sysstatユーティリティ
- システムの状態を監視するためのツールを提供
	- `sar` や`iostat`コマンドが代表例

### nfsiostat
- NFSのI/Oを表示

### cifsiostat
- CIFSのI/Oを表示

#### CIFS
- Common Internet File System
- SMB(Server Message Block)を拡張したプロトコルでWin系OSにおいてファイル共有やプリンタ共有などを可能にするMS独自のプロトコル
- Linuxでは、CIFSによるネットワーク共有を利用することが出来、NFSと同じくローカルファイルシステムにマウントして利用出来る

### iotop
- ディスクI/Oの情報がプロセス毎に確認出来る

### top
- 全体及びプロセスごとのCPUやメモリの使用状況を一定時間ごとに更新して表示するコマンド
- %us ユーザプロセスの割合
- %sy システムプロセスの割合
- %wa I/O待ち時間の割合
- %hi ハードウェアの割り込み処理の割合
- %si ソフトウェアの割り込み処理の割合
- %ni nice値(優先度)つきプロセスの割合
- %st バーチャルマシンに使用された時間の割合
- 1行目: wコマンド、uptimeコマンドと同様
- 2行目: プロセスについて表示
- 3行目: CPUの使用状況
- 4行目: メモリの使用状況
- 5行目: スワップ領域の使用状況
- 6行目以降: 各プロセスの情報を表示
- ディスクI/Oは、表示出来ない

### vmstat
- 物理メモリやスワップ領域の詳細な情報や、プロセスのCPUの統計情報などを表示
	- 各プロセス毎の情報は表示出来ない
- procs欄 プロセスの統計情報
	- `r` 実行街のプロセス数
	- `b` I/O待ちなどで割り込み不可のスリープ状態にあるプロセス数
	- `w` スワップアウトされているプロセスの数
- memory欄 メモリの使用状況
	- `cache` ページキャッシュのサイズ
- swap欄 スワップイン・アウトの状況
- io欄 ディスクIOの状態
    - bi デバイスからの読み取りブロック数/秒
    - bo デバイスへの書き込みブロック数/秒
- system欄 割り込み回数やコンテキストスイッチ回数
	- `cs` コンテキストスイッチ数/秒
	- `in` 割り込み(クロック割り込み含む)回数/秒
- cpu欄 CPUの使用状況
- 負荷平均(Load Average)は、表示出来ない

### netstat
- ネットワークの状態に関する情報を表示
- -iオプションでインターフェイスの状態を表示
	- `RX-ERR` 受信時にエラーとなったパケット数
- `-s`オプションでプロトコル毎にパケットの送受信に関する情報を表示

### ps
- 稼働中のプロセスおよび、プロセスごとのCPUやメモリの使用量を表示
	- 物理メモリの使用量は`RSS`で確認

### ss
- netstatコマンドを代替するコマンド
- `ss -nt` TCP接続を表示し、アドレス:ポートを数字で表示

### htop
- CPU,メモリなどのリソース情報を表示
- topと似た情報内容だがカラーで表示され、ファンクションキーい様々な機能が割り当てられている

### iptraf
- グラフィカルな画面でネットワークインターフェイスのトラフィックを表示

### iw
- 無線インターフェイスを設定

### sar
- sadcコマンドが収集した様々な情報を表示するコマンド
- sadcコマンドは、cronの設定により定期的に実行される
    - 収集した情報は、`/var/log/sa/saXX`ファイルに書き込まれる
- `-u`オプションは、システム全体としてのCPU使用率を表示
- `-b`オプションは、ディスクI/Oの状況を表示(I/O転送リクエスト数/秒)
- `-r`オプションは、物理メモリ及びスワップ領域の使用状況を表示
- `-n DEV`オプションは、ネットワークインターフェイスの送受信パケットに関する情報を表示
- `-n EDEV`オプションは、ネットワークインターフェイスの送受信エラーパケットに関する情報を表示
- `-P n|ALL` 指定したCPUの使用率を表示

#### sadf
- sarコマンドで収集したデータは、sadfコマンドを使って様々な形式に変更出来る
- sarコマンドのオプションを指定して私、結果の出力を整形出来る
- `--`をつけてsarコマンドのオプションを渡す

#### sa1
- sadcの定期的な実行

#### sa2
- sarの定期的な実行

### iostat
- CPUの利用状況およびディスクI/Oの状況などを表示
	- システム全体のCPU使用率を表示
		- CPU毎の使用率は表示出来ない
- 最初の表示は、起動時からの統計情報
	- 2回目移行の表示は、前回のデータとの差分
- swap in/swap outは、表示出来ない

### w
- Load Averageを表示
- システムの稼働時間を表示
- ログインしているユーザとそのプロセス情報を表示
	- メモリ情報は表示しない

### free
- メモリやスワップ領域の使用状況を表示する
- `-/+ buffers/cache:` バッファキャッシュ(buffers)とページキャッシュ(cached)を考慮して、実質的に使用されている領域、空いている領域のサイズを表示;

### lsof
- ファイルを開いているプロセスを表示するコマンド

### uptime
- Load Averageを表示
	- 1分 5分 15分 のものを表示

### pstree
- 動作中のプロセスの親子関係をツリー状で表示するコマンド
- `-p` PIDも表示

### スワップ領域の使用頻度が増加した場合の問題点
- Linuxは、物理メモリがある場合、処理の高速化のためバッファキャッシュ及びページキャッシュを積極的に利用する
	- 稼働時間がながければ長いほど空いている物理メモリは次第に少なくなる
- メモリを必要としているプロセスが発生した場合、メモリの空き容量が不足していれば、キャッシュはクリアされる
	- 空き容量が単純に少ないからと言って、すぐに物理メモリの容量が不足しているとは判断出来ない
	- バッファキャッシュとページキャッシュのサイズに注目
- スワップアウト、スワップインが頻発する場合、プロセスの見直しや物理メモリの増設などの対処が必要とかんがえられる

### mpstat
- システム全体及びCPU毎の使用率を表示
- `-P n|ALL` CPUを番号で指定し、使用率を表示

### swapon
- スワップ領域を有効にする
- `-s` 利用状況を表示

## キャパシティプランニング

### 監視するべきリソース
- 状態を測定、監視、記録する
	- ネットワークI/O
	- CPU使用率
	- メモリ使用率
	- ディスクI/O

### リソースの利用状況を継続的に監視する必要性
- キャパシティプランニング
- 需要予測
- 問題調査

### Icinga2
- Nagios互換の監視ツール
- V2によって互換性はなくなったが、WebAPIを使って監視情報のやり取りが出来たりする

### Cacti
- ネットワークやリソースの使用状況を監視し、グラフ化するツール
- MRTGの代替として使用される
- Nagiosと異なり、死活監視は行えない

### collectd
- サーバの状態を監視するデーモン
- システムにかかる負荷が少ないo
- データの監視、記録にはプラグインを追加する必要がある

#### LoadPlugin
- 監視対象を指定する

### SNMP
- Simple Network Management Protocol
