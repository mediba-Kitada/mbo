# デバイス、Linuxファイルシステム、ファイルシステム標準(主題104)

## 1. パーティションとファイルシステムの作成
### parted
- MBR形式、GPT形式をサポートするパーティション操作コマンド
- パーティションテーブルの方式をGPT形式とする```mklabel gpt```
- ```-s```オプションに続けて、対話形式のサブコマンドを指定することも出来る
    - パーティションテーブルの方式をGPT形式とする```parted -s mklabel gpt```
- パーティションテーブルの方式をMBR形式を明示的に指定 ```mklabel msdos```
- パーティションを作成 ```mkpart```
    - 先頭に1つの1000MBの基本パーティションにファイルシステム ext4を指定 ```mkpart primary ext4 1 1000MB```
        - 基本パーティション ```primary```
        - 拡張パーティション ```extended```
        - 論理パーティション```logical```

### XFS
- 動的inode
    - ファイル作成時にinode番号を動的に割り当てる
    - inode数に制限は無い
- SGIが開発
### ReiserFS
- 動的inode
- Hans Reiserらが開発
### JFS
- 動的inode
- IBMが開発
### swapon
- スワップ領域を有効にする
### Btrfs
- 次世代のLinux標準ファイルシステム
- バターエフエス、ビーツリーエフエス
### mke2fs
- ext2/ext3/ext4ファイルシステムを作成
- デフォルトでは、ext2で作成
- ext3ファイルシステムを /dev/sda2 に作成 ```mke2fs -j /dev/sda2``` ```mke2fs -t ext3 /dev/sda2```
    - ```-j```オプションでext3ファイルシステムを指定
        - ジャーナリングファイルシステムを意味する
### mkfs
- デフォルトでは、ext2で作成
- ext2/ext3/ext4/ReiserFS/XFSのファイルシステムを作成
### fdisk
- MBR方式のハードディスク /dev/sda デバイスのパーティションテーブルを確認 ```fdisk -l /dev/sda```
### IDEハードディスク
- 1番目のIDEハードディスクの2番目のパーティションを表すデバイスファイル ```/dev/hda2```

## 2. ファイルシステムの整合性の保守
### fsck
- ファイルシステムのチェック、および問題を修復する事が出来る
- /etc/fstabファイルに記述されている全ファイルシステムをチェックする ```fsck -A```
- ファイルシステムの整合性をチェックする際、障害箇所を自動的に修復 ```fsck -a```
### e2fsck
- ファイルシステムのチェック、および問題を修復する事が出来る
    - ext2/etx3/ext4に限る
- /dev/sda4をチェックする際、全ての問題を自動的に修復 ```e2fsck -p /dev/sda4```
### tune2fs
- ext2/ext3/ext4ファイルシステムのパラメータを調整
- ext2ファイルシステムの/dev/hda5をext3に変換 ```tune2fs -j /dev/hda5```
    - ```-j```オプションは、ジャーナリングファイルシステムを表している
### dumpe2fs
- ext2/ext3/ext4ファイルシステムの各種情報を表示するコマンド
### debugfs
- ファイルシステムの対話的なデバッガ
    - ext2/ext3/ext4に限る
### xfs_info
- XFSファイルシステムの情報を表示するコマンド
### xfs_metadump
- XFSファイルシステムのメタデータをバックアップするコマンド
### mkfs.xfs
- XFSファイルシステムを作成する
### du
- dirディレクトリとサブディレクトリが占めている容量をわかりやす単位を付加して表示する。ただし、サブディレクトリの容量は含めず別途dirディレクトリ内の合計容量を表示する ```du -chS dir```
    - ```-c```オプションで合計容量も同時に表示
    - ```-h```オプションで分かりやすい単位を付加して表示
    - ```-S```オプションでディレクトリ容量にサブディレクトリの容量を含めずに表示
- dirディレクトリの合計容量のみを分かりやすい単位を付加して表示 ```du -sh```
    - ```-s```オプションで指定したフィアルやディレクトリの合計容量のみを表示
### df
- デバイス(パーティション)の空き容量を確認することが出来る

## 3. ファイルシステムのマウントとアンマウントの制御
### /etc/mtab
- 現在マウントされているファイルシステムの情報が格納されている
### /etc/fstab
- 利用するファイルシステムのマウント設定を事前に行っておく設定ファイル
- 書式 デバイス名(デバイスファイル名orラベル) マウントポイント ファイルシステムの種類 マウントオプション dumpフラグ fsckフラグ
    - ```/dev/sda1 /boot ext3 defaults 1 1```
- 一般ユーザによるマウントを禁止するマウントオプション ```nouser```
- 一般ユーザでマウント可能、誰でもアンマウント出来る ```users```
### mount
- ファイルシステムをマウントする
    - マウントとは、デバイスとその上に構築されているファイルシステムをOSに認識させ、指定のディレクトリに割当、そのディレクトリ以下のファイルシステム内にアクセス出来るようにすること
- デバイスとマウント先のどちらも指定しなかった場合は、現在マウントされているファイルシステムを一覧表示する
    - ```/proc```ディレクトリのは以下に様々なリソース情報が収められおり、```/proc/self/mounts```と```/proc/mounts```ファイルにも同様の情報が格納されている

## 4. ディククオータの管理
- ユーザまたはグループ毎にディスク容量を制限する機能
### quota
- 指定したユーザやグループのクォータ状況を表示する
- ファイルシステムを引数に取ることは出来ない
### edquota
- 指定したユーザのディククオータの設定を別のユーザのディスククォータの設定にコピー ```edquota -p test test2```
### repquota
- 指定したファイルシステムのディスククォータ状況を表示するコマンド
- /etc/fstabに```/dev/hda5 /export reiserfs defaults,usrquota,grpquota 0 3```と記載されている場合、/dev/hda5のクォータが設定されているユーザのディククォータの状況を表示する ```repquota -u /export``` ```repquota -u /dev/hda5```
    - ```usrquota```マウントオプションでユーザ毎のディスククォータを設定している
### quotacheck
- ファイルシステムのディスク使用量をチェックし、クオータの情報を格納するファイルを作成、更新する

## 5. ファイルのパーミッションと所有者の管理
### chown
- dirディレクトリ及びそのその配下にあるファイルの所有グループをstaffgroupに変更 ```chwon -R :staffgroup dir```
- file.txtの所有グループのみをtestからstaffgroupに変更 ```chown .staffgroup file.txt```
### chmod
- dirディレクトリ及びその配下にあるファイルのパーミッションを755に設定 ```chmod -R a=rwx,go-w dir```
    - ```a```で対象を全てのユーザとしておき、```go-w```でグループ及びその他のユーザから書き込み権限を削除する
- 自分以外のユーザが所有するファイルを削除出来ないようにする
    - スティッキービットの利用
    - ```chmod o+t dir```
    - ```chmod 1755 dir``` 通常のパーミッションに1000を加えた値を設定する
- プログラムfileをどのユーザが実行してもプログラムの所有者の権限で実行させる
    - SUIDの利用
    - ```chmod u+s file``` その他のユーザにtという権限を付与
    - ```chmod 4755 file``` 通常のパーミッションの値に4000を加えた値を設定
### スティッキービット
- 自分に以外のユーザが所有するファイルを削除出来ないようにする
    - 通常のパーミッションの値に1000を加えた値を設定
### SUID
- プログラブをどのユーザが実行しても、プログラムの所有ユーザ権限で実行するようにする仕組み
    - 通常のパーミッションの値に4000を加えた値を設定
### SGID
- プログラムをどのユーザが実行しても、プログラムの所属グループ権限で実行するようにする仕組み
    - 通常のパーミッションの値に2000を加えた値を設定
### umask
- ファイルやディレクトリを新規作成した際のデフォルトのパーミッションを設定するコマンド
- マスク値を設定する
### マスク値
- ファイルは666,ディレクトリは777からマスク値を引いた値がデフォルトのパーミッションとして設定される

## 6. ハードリンクとシンボリックリンクの作成・変更
### ハードリンク
- ファイルの実態を直接参照するリンク
    - ファイルを新規作成した場合は、ハードリンクが1つある状態となる
- 同じファイルの実体を指す全てのハードリンクは、inode番号が同じ

## 7. システムファイルの確認と適切な位置への配置
### /usr/sbin
- システム起動には必須ではない、システム管理用のコマンドを格納
### find
- 検索結果をNULL文字で区切って表示する ```find -print0```
    - xargsに渡す際、デフォルトでは改行コードもしくはスペースで区切られてしまうため、スペースを含む検索結果を意図した通りに処理するために利用する
    - NULL文字(NULL \0 16進数で00)は制御コードのひとつで、C言語や様々なデータ・フォーマットにおいて文字列の終端を意味する
- ファイルの種類で検索
    - ファイルを検索 ```find -type f```
    - ディレクトリを検索 ```find -type d```
    - シンボリックリンクを検索 ```find -type l```
- 検索結果のファイルに対してコマンドを実行 ```find -user root -exec rm {} \;```
    - {}は検索結果のファイルに置換される
    - ;はコマンドの終了を意味するが、メタキャラクタなので\でエスケープ
- 2日以内にアクセスされたファイルを検索 ```find .  -atime -2```
### updatedb
- localteコマンドが利用する検索用のデータベースを更新する
- 設定ファイルとして ```/etc/updatedb.conf``` を利用する
