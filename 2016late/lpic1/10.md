# セキュリティ*(主題110)

## 1 セキュリティ管理業務の実施
### last
- 最近ログインしたユーザの一覧を表示するコマンド
- ```/var/log/wtmp```ユーザのログイン/ログアウト情報が記録されているバイナリファイルファイルを参照
### w
- 現在システムにログインしているユーザの情報を表示
### who
- 現在システムにログインしているユーザの情報を表示 
### /var/run/utmp
- ログイン中のユーザの情報が格納されているバイナリファイル
### ulimit
- ユーザやシェルが利用できるリソースを制限するコマンド
- 制限値の一覧表示 ```ulimit -a```
- 出力出来るファイルのサイズを制限 ```ulimit -f```
- コアファイルをサイズを制限する ```ulimit -c```
    - プログラムが異常終了した時にプログラムが使用していたメモリ情報をファイルに書き出したもの
- ユーザが利用出来るプロセス数を1024に制限 ```ulit -u 1024```
### chage
- パスワードの有効期限の設定に特化したコマンド
    - ```CHange password AGE```の略
- パスワードの有効期限が切れてから7日後にアカウントを無効にする ```chage -I 7 kitada```
- パスワード変更の間隔の最短日数を指定する ```chage -m 3 kitada```
- パスワードが有効な最長日数を指定する```chage -M 4 kitada```
- パスワードの有効期限が切れる前に警告を表示する日数を指定 ```chage -W 1 kitada```
- パスワードの有効期限に関する情報を表示 ```chage -l kitada```
```
Last password change                                    : Mar 04, 2017
Password expires                                        : Mar 08, 2017
Password inactive                                       : Mar 15, 2017
Account expires                                         : never
Minimum number of days between password change          : 3
Maximum number of days between password change          : 4
Number of days of warning before password expires       : 1
```
- アカウントの有効期限を指定 ```chage -E 2017-03-31 kitada```
- パスワードの有効期限に関する設定が可能なコマンド ```passwd``` ```usermod```
### /etc/shadow
- パスワードの有効期限に関する情報が記載されている
### SUID/SGIDの設定の確認
- SUIDとSGIDの両方が設定されたファイルを全て把握 ```find / -perm -6000```
    - find -perm -MODE で指定されている許可属性ビットの全てがファイルに立っていたら真
- ルートユーザの所有権を持ち、かつSUIDが設定されたファイルをすべて把握する ```find / -perm -u+s -uid0``` ```find / -perm -4000 -uid 0```
    - rootユーザは、ユーザIDおよびグループIDがともに0
    - SUIDはビットで表現すると4000、記号表現だとu+s
### fuser
- システムの特定のリソースを使用中のプロセスを検索し、強制終了することが出来るコマンド
- 対象ファイルに書き込みをしているプログラムのプロセスID、実行ユーザ情報の確認と強制終了を同時に実施 ```fuser -uk /tmp/.keylog```
- TCP 65432ポートを利用している不正プログラムの確認と強制終了 ```fuser -k -n tpc 65432```
- リソースを使用中のプロセスの実行ユーザを特定 ```fuser -v``` ```fuser -u```
### lsof
- システムの特定のリソースを使用中のプロセスを検索
- ポート25を利用しているプロセスの確認 ```lsof -i:25```
### su
- 引数に-をつけると、切り替わる先のユーザの環境変数を使用する
- 切り替わる先のユーザのパスワードを求められる
### nmap
- 指定したホストのポートを一覧表示(ポートスキャン)することが出来る

## 2 ホストのセキュリティ設定
### スーパーサーバ
- 登録された利用頻度の低いサービスを関しし、リクエストが来た場合にだけ、該当のサービスを実行
- 利用頻度の低いサービスをシステムにデーモンとして常駐させる必要が無くなり、メモリやCPU等のリソースの消費を抑えられる
### inted
- アクセス制御を行う際は、TCP/Wrapperを利用する
- intedが監視しているサービスにアクセスがあると、tcpdにその制御を渡す
    - tcpdは、```/etc/hosts.allow```と```/etc/hosts.deny```ファイルを調べ、アクセスを許可するかどうか判断する
- intedを介してサービスを起動させたく無い場合は、```/etc/inted.conf```の該当サービスの行をコメントアウト(#)する
- 設定の反映には、inetdを再起動する必要がある
    - ```killall -HUP inetd```
    - ```/etc/init.d/inetd restart```
    - ```kill -HUP PID```
### xinetd
- intedより新しいスーパーサーバでサービスごとに詳細な設定が可能
- 全体的な設定は、```/etc/xinetd.conf```行う
- ```/etc/xinetd.d/```ディレクトリ内の設定ファイルでサービス個別の設定を実施
- アクセス制御
    - only_fromだけが設定されいている場合、指定されたアクセス元しかサービスへアクセス出来ない
    - no_accessだけが設定さている場合、指定されたアクセス元はサービスへアクセス出来ない
    - only_fromもno_accessも設定されていない場合、サービスへのアクセスは全て許可
    - only_fromとno_accessが同時に指定された場合、より厳密にマッチする方に従う
- 設定項目
    - サーバプログラムを起動するユーザ ```user```
    - サーバプログラム(デーモン)のプロセス最大起動数 ```instances```
        - 未指定の場合は、無制限(UNLIMITED)となるので、適切な上限値を設定するべき
    - ログの記録先を指定。サービスが出力するログをsyslogや指定したファイルに出力する。出力先ファイルは絶対パスで指定する ```log_type```
    - サービスを利用しない ```disable=yes```
    - サービスの接続タイプを設定 ```socket_type```
    - サーバプログラムへの接続処理を待ち合わせるのか設定 ```wait```
        - シングルスレッドの場合は、yesを設定し、プログラムが終了するまで接続処理を待ち合わせる
        - マルチスレッドの場合は、noを設定し、1プロセスで同時に複数処理させる
    - サーバプログラムへの絶対パス ```server```
    - サーバプログラムへの引数 ```server_args```
```
{
  disable         = yes
  type            = INTERNAL
  id              = echo-dgram
  socket_type     = dgram
  protocol        = udp
  user            = root
  wait            = yes
}
```
### TCP/Wrapper
- デーモン ```tcpd```
- アクセス制御
    - /etc/hosts.allowに記載されいているホストは許可
    - /etc/hosts.allowに記載されていなければ、/etc/hosts.denyを参照し、記載されているホストは許可
    - 両方のファイルに記載の無いホストは全て許可
    - 一般的には/etc/hosts.denyにALL:ALLと記載しておき(全てのサービスとホストを拒否)、許可したサービスとホストだけ/etc/hosts.allowに記載
### /etc/nologin
- ファイルが存在した場合、一般ユーザのログインを禁止する

## 3 暗号化によるデータの保護
### gpg
- GnuPGを使用して、ファイルの暗号化や復号化を行う
- メールアドレスで公開鍵のユーザを指定 ```gpg -e -r user@ping-t.com hoge.txt```
    - -eオプションで相手方の公開鍵を利用して、暗号化
- 設定ファイルは、```~/.gnuphp/```に配置される
- 公開鍵の出力 ```gpg -o pubke --export user1@ping-t.com```
### ssh-keygen
- 忘れてしまったパスフレーズを表示、消去する方法な無い
### ssh
- クライアントの設定ファイル ```/etc/ssh/ssh_config```
- サーバの設定ファイル ```/etc/ssh/sshd_config```
- 接続時のユーザ名を指定 ```ssh -l user1``` ```ssh -o User=user1```
    - -oオプションでssh_configに記載されている項目を有効にする
#### ホスト認証(公開鍵方式)
- サーバの持つ公開鍵をクライアントに登録しておき、クライアントがサーバへSSH接続を行った際、クライアントは登録されている公開鍵とサーバの公開鍵が一致するかどうかを確認する
#### ユーザ認証(公開鍵方式、もしくはID/パスワード方式)
- クライアントの持つ公開鍵をサーバに登録しておき、サーバがSSH接続を受け付けた際、サーバは登録されている公開鍵とユーザの公開鍵が一致するかどうかを確認する
- 設定値
    - rootユーザでのSSHログインを禁止 ```PermitRootLogin no```
#### ポートフォワーディング
- ローカルのポート8000に接続するとSSHサーバ内のWEBサーバに接続するようにしたい ```ssh -L 8000:localhost:80 user@ssh-server```
    - -Lオプション Local port forwarding
#### X11フォワーディング
- Xサーバクライアントとの通信に特化し、通信の暗号化、設定作業を簡略化出来る
- SSHサーバにおいて、X11Forwarding yes の設定が必要
- DISPLAY環境変数(Xクライアント表示用)は自動的に設定される
- ```ssh -X user@ssh-server X11Command```
### ssh-agent
- メモリ上に秘密鍵を保管しておく認証エージェント
- 認証鍵(秘密鍵)を登録する ```ssh-add```
